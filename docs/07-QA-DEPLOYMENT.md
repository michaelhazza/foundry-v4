# QA & Deployment Specification: Foundry

**Generated by:** QA & Deployment Agent v5.0  
**Date:** January 8, 2026  
**Status:** COMPLETE

## Document Information

| Field | Value |
|-------|-------|
| Document ID | 07-QA-DEPLOYMENT |
| Version | 1.0 |
| Last Updated | January 8, 2026 |
| Status | Complete |
| Upstream Dependencies | 01-PRD, 02-ARCH, 03-DATA, 04-API, 05-UI, 06-IMPL |

## Specification Summary

| Category | Count |
|----------|-------|
| User Stories Covered | 35 |
| Test Requirements | 87 |
| API Endpoints Covered | 52 |
| UI Screens Covered | 15 |
| Environment Variables | 8 |

---

## 1. Test Strategy

### 1.1 Test Layers

| Layer | Purpose | Recommended Tools | Scope |
|-------|---------|-------------------|-------|
| Unit | Isolated function testing | Vitest | Services, utilities, PII engine |
| Integration | API endpoint testing | Supertest + Vitest | All 52 endpoints |
| Component | UI component testing | Testing Library + Vitest | Forms, interactive elements |
| E2E | User flow testing | Playwright | Critical paths |

### 1.2 Coverage Targets

| Category | Target | Rationale |
|----------|--------|-----------|
| API Endpoints | 100% | Every endpoint tested for success and error paths |
| API Response Codes | All documented | Every status code (200, 201, 400, 401, 403, 404, 409, 422, 429, 500) |
| UI Screens | All screens, all states | Loading, default, empty, error states |
| Form Validation | All fields, all rules | Client-side and server-side validation |
| User Stories | All acceptance criteria | Every AC maps to at least one test requirement |

### 1.3 Testing Priority

| Priority | Category | Examples |
|----------|----------|----------|
| P0 | Auth & Security | Login, token validation, rate limiting, multi-tenant isolation |
| P0 | Health Check | Deployment verification |
| P1 | Core CRUD | Projects, sources, jobs, exports |
| P1 | Processing Pipeline | File upload → mapping → processing → export |
| P2 | Admin Features | Platform admin, audit logs |

---

## 2. Test Requirements

### 2.1 Authentication Tests

#### TR-AUTH-001: User Login with Valid Credentials

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-002, AC: correct credentials → logged in within 2 seconds |
| Type | Integration |
| Component Under Test | POST /api/auth/login |
| Preconditions | User exists with known email/password |
| Test Input | `{ email: "user@test.com", password: "ValidPass123!" }` |
| Expected Result | Login successful, tokens returned |
| Verification Points | Response status is 200; Response contains accessToken and refreshToken; Response contains user object with id, email, name; Response time < 2 seconds |

#### TR-AUTH-002: User Login with Invalid Credentials

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-002, AC: incorrect credentials → generic error message |
| Type | Integration |
| Component Under Test | POST /api/auth/login |
| Preconditions | User exists |
| Test Input | `{ email: "user@test.com", password: "WrongPassword" }` |
| Expected Result | Login rejected |
| Verification Points | Response status is 401; Error code is INVALID_CREDENTIALS; Message does not indicate which field is wrong |

#### TR-AUTH-003: Login Rate Limiting

| Field | Value |
|-------|-------|
| Traces to | F-001: 5 attempts/minute rate limit |
| Type | Integration |
| Component Under Test | POST /api/auth/login |
| Preconditions | None |
| Test Input | 6 rapid login attempts |
| Expected Result | 6th request rate limited |
| Verification Points | First 5 requests return 200 or 401; 6th request returns 429; Response includes X-RateLimit headers |

#### TR-AUTH-004: Session Expiry

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-002, AC: 24-hour session expiry |
| Type | Integration |
| Component Under Test | GET /api/auth/me with expired token |
| Preconditions | Access token with past expiry |
| Test Input | Expired JWT in Authorization header |
| Expected Result | Request rejected |
| Verification Points | Response status is 401; Error code is TOKEN_EXPIRED |

#### TR-AUTH-005: Password Reset Flow

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-005 |
| Type | Integration |
| Component Under Test | POST /api/auth/forgot-password, POST /api/auth/reset-password |
| Preconditions | User exists with known email |
| Test Input | Valid email, then valid reset token + new password |
| Expected Result | Password updated successfully |
| Verification Points | Forgot-password returns 200; Reset-password returns 200; Can login with new password |

#### TR-AUTH-006: Expired Password Reset Token

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-005, AC: reset link > 1 hour old |
| Type | Integration |
| Component Under Test | POST /api/auth/reset-password |
| Preconditions | Reset token created > 1 hour ago |
| Test Input | Expired token + new password |
| Expected Result | Reset rejected |
| Verification Points | Response status is 422; Error code is RESET_TOKEN_EXPIRED |

### 2.2 Invitation Tests

#### TR-INV-001: Send Invitation

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-001, AC: invitation email sent within 60 seconds |
| Type | Integration |
| Component Under Test | POST /api/invitations |
| Preconditions | Authenticated as org admin |
| Test Input | `{ email: "newuser@test.com", role: "editor" }` |
| Expected Result | Invitation created |
| Verification Points | Response status is 201; Invitation record created in database; Email service called (or logged in dev) |

#### TR-INV-002: Accept Invitation

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-001, AC: recipient can create account and join org |
| Type | Integration |
| Component Under Test | POST /api/invitations/:token/accept |
| Preconditions | Valid pending invitation |
| Test Input | `{ name: "New User", password: "ValidPass123!" }` |
| Expected Result | User created and joined to organization |
| Verification Points | Response status is 201; User record created; Organization membership created with correct role |

#### TR-INV-003: Expired Invitation

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-001, AC: 7-day expiry |
| Type | Integration |
| Component Under Test | GET /api/invitations/:token/validate |
| Preconditions | Invitation created > 7 days ago |
| Test Input | Expired invitation token |
| Expected Result | Invitation rejected |
| Verification Points | Response status is 422; Error code is INVITATION_EXPIRED |

### 2.3 Role-Based Access Tests

#### TR-ROLE-001: Viewer Cannot Modify

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-003, AC: Viewer can view but not modify |
| Type | Integration |
| Component Under Test | POST /api/projects (as Viewer) |
| Preconditions | Authenticated as user with Viewer role |
| Test Input | `{ name: "New Project" }` |
| Expected Result | Request forbidden |
| Verification Points | Response status is 403; Error code is INSUFFICIENT_PERMISSIONS |

#### TR-ROLE-002: Editor Can Create Projects

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-003, AC: Editor can modify and trigger processing |
| Type | Integration |
| Component Under Test | POST /api/projects (as Editor) |
| Preconditions | Authenticated as user with Editor role |
| Test Input | `{ name: "New Project", description: "Test" }` |
| Expected Result | Project created |
| Verification Points | Response status is 201; Project record created |

#### TR-ROLE-003: Admin Can Manage Users

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-003, AC: Admin can manage users |
| Type | Integration |
| Component Under Test | PATCH /api/team/:userId (as Admin) |
| Preconditions | Authenticated as org admin, target user exists |
| Test Input | `{ role: "admin" }` |
| Expected Result | Role updated |
| Verification Points | Response status is 200; User role changed in database |

#### TR-ROLE-004: Remove Team Member Revokes Access

| Field | Value |
|-------|-------|
| Traces to | US-AUTH-004, AC: removed user's sessions terminated |
| Type | Integration |
| Component Under Test | DELETE /api/team/:userId |
| Preconditions | Target user has active session |
| Test Input | User ID |
| Expected Result | User removed, access revoked |
| Verification Points | Response status is 200; User's subsequent API calls return 401 |

### 2.4 Project Tests

#### TR-PROJ-001: Create Project

| Field | Value |
|-------|-------|
| Traces to | US-ORG-002, AC: project created in under 2 seconds |
| Type | Integration |
| Component Under Test | POST /api/projects |
| Preconditions | Authenticated as Editor or Admin |
| Test Input | `{ name: "Test Project", description: "Description" }` |
| Expected Result | Project created |
| Verification Points | Response status is 201; Response time < 2 seconds; Project appears in list |

#### TR-PROJ-002: Project Name Validation

| Field | Value |
|-------|-------|
| Traces to | US-ORG-002, AC: name > 100 chars → validation error |
| Type | Integration |
| Component Under Test | POST /api/projects |
| Preconditions | Authenticated |
| Test Input | Name with 101 characters |
| Expected Result | Validation error |
| Verification Points | Response status is 422; Error indicates field and constraint |

#### TR-PROJ-003: Archive Project

| Field | Value |
|-------|-------|
| Traces to | US-ORG-003 |
| Type | Integration |
| Component Under Test | POST /api/projects/:projectId/archive |
| Preconditions | Project exists, not archived |
| Test Input | Project ID |
| Expected Result | Project archived |
| Verification Points | Response status is 200; Project status is archived; Project excluded from default list |

### 2.5 File Upload Tests

#### TR-FILE-001: Upload CSV Success

| Field | Value |
|-------|-------|
| Traces to | US-FILE-001, AC: upload completes, columns auto-detected |
| Type | Integration |
| Component Under Test | POST /api/projects/:projectId/sources/file |
| Preconditions | Project exists |
| Test Input | Valid CSV file < 50MB |
| Expected Result | Source created with detected columns |
| Verification Points | Response status is 201; Source record created; Column metadata populated |

#### TR-FILE-002: File Size Limit Enforced

| Field | Value |
|-------|-------|
| Traces to | US-FILE-001, AC: file > 50MB → error before upload |
| Type | Integration |
| Component Under Test | POST /api/projects/:projectId/sources/file |
| Preconditions | None |
| Test Input | File > 50MB |
| Expected Result | Upload rejected |
| Verification Points | Response status is 400; Error code is FILE_TOO_LARGE |

#### TR-FILE-003: Invalid File Type

| Field | Value |
|-------|-------|
| Traces to | F-003: Unsupported format error |
| Type | Integration |
| Component Under Test | POST /api/projects/:projectId/sources/file |
| Preconditions | None |
| Test Input | Unsupported file type (e.g., .pdf) |
| Expected Result | Upload rejected |
| Verification Points | Response status is 400; Error code is INVALID_FILE_TYPE |

#### TR-FILE-004: Excel Sheet Selection

| Field | Value |
|-------|-------|
| Traces to | US-FILE-002, AC: multiple sheets → can select which to import |
| Type | Integration |
| Component Under Test | POST /api/projects/:projectId/sources/file |
| Preconditions | None |
| Test Input | Excel file with multiple sheets |
| Expected Result | Sheet list returned for selection |
| Verification Points | Response includes available sheets; Can specify sheet in subsequent request |

#### TR-FILE-005: JSON Nested Path Selection

| Field | Value |
|-------|-------|
| Traces to | US-FILE-003, AC: nested objects → can select path |
| Type | Integration |
| Component Under Test | POST /api/projects/:projectId/sources/file |
| Preconditions | None |
| Test Input | JSON file with nested structure |
| Expected Result | Path options returned |
| Verification Points | Response includes detected paths; Can specify path for array import |

### 2.6 API Source Tests

#### TR-API-001: Teamwork Desk Connection Success

| Field | Value |
|-------|-------|
| Traces to | US-API-TD-001, AC: test connection success/failure within 5 seconds |
| Type | Integration |
| Component Under Test | POST /api/sources/:sourceId/test |
| Preconditions | Teamwork Desk source configured |
| Test Input | Valid API key and subdomain |
| Expected Result | Connection verified |
| Verification Points | Response status is 200; Response time < 5 seconds; Source status updated to connected |

#### TR-API-002: Teamwork Desk Invalid Credentials

| Field | Value |
|-------|-------|
| Traces to | US-API-TD-001, AC: specific error for auth failures |
| Type | Integration |
| Component Under Test | POST /api/sources/:sourceId/test |
| Preconditions | Teamwork Desk source with invalid API key |
| Test Input | Invalid API key |
| Expected Result | Auth failure returned |
| Verification Points | Response status is 422; Error code is CONNECTION_FAILED; Message indicates authentication issue |

#### TR-API-003: GoHighLevel Connection

| Field | Value |
|-------|-------|
| Traces to | US-API-GHL-001 |
| Type | Integration |
| Component Under Test | POST /api/projects/:projectId/sources/gohighlevel |
| Preconditions | Project exists |
| Test Input | Valid GoHighLevel credentials |
| Expected Result | Source connected |
| Verification Points | Response status is 201; Source status is connected |

### 2.7 Processing Tests

#### TR-PROC-001: Start Processing

| Field | Value |
|-------|-------|
| Traces to | US-PROC-001, AC: processing starts within 10 seconds |
| Type | Integration |
| Component Under Test | POST /api/projects/:projectId/jobs |
| Preconditions | Project with configured sources and mappings |
| Test Input | Project ID |
| Expected Result | Job created and started |
| Verification Points | Response status is 201; Job status is running or pending; Job visible in history |

#### TR-PROC-002: Cancel Running Job

| Field | Value |
|-------|-------|
| Traces to | US-PROC-003, AC: processing stops within 30 seconds |
| Type | Integration |
| Component Under Test | POST /api/jobs/:jobId/cancel |
| Preconditions | Job in running state |
| Test Input | Job ID |
| Expected Result | Job cancelled |
| Verification Points | Response status is 200; Job status changes to cancelled |

#### TR-PROC-003: Cancel Non-Running Job

| Field | Value |
|-------|-------|
| Traces to | F-010: JOB_NOT_CANCELLABLE error |
| Type | Integration |
| Component Under Test | POST /api/jobs/:jobId/cancel |
| Preconditions | Job in completed state |
| Test Input | Job ID |
| Expected Result | Cancel rejected |
| Verification Points | Response status is 422; Error code is JOB_NOT_CANCELLABLE |

### 2.8 Export Tests

#### TR-EXP-001: Generate JSONL Export

| Field | Value |
|-------|-------|
| Traces to | US-EXP-001, AC: file downloads within 10 seconds for < 10K records |
| Type | Integration |
| Component Under Test | POST /api/jobs/:jobId/exports |
| Preconditions | Completed processing job |
| Test Input | `{ format: "conversational_jsonl" }` |
| Expected Result | Export generated |
| Verification Points | Response status is 201; Export file created; Each line is valid JSON with messages array |

#### TR-EXP-002: Download Export

| Field | Value |
|-------|-------|
| Traces to | US-EXP-001 |
| Type | Integration |
| Component Under Test | GET /api/exports/:exportId/download |
| Preconditions | Export exists and not expired |
| Test Input | Export ID |
| Expected Result | File downloaded |
| Verification Points | Response status is 200; Content-Disposition header set; File content matches expected format |

#### TR-EXP-003: Expired Export

| Field | Value |
|-------|-------|
| Traces to | US-EXP-004, AC: export > 30 days shows as expired |
| Type | Integration |
| Component Under Test | GET /api/exports/:exportId/download |
| Preconditions | Export created > 30 days ago |
| Test Input | Expired export ID |
| Expected Result | Download rejected |
| Verification Points | Response status is 410 or 422; Error code is EXPORT_EXPIRED |

### 2.9 Multi-Tenant Isolation Tests

#### TR-MT-001: Cross-Organization Data Access Blocked

| Field | Value |
|-------|-------|
| Traces to | Architecture: All data access must be org-scoped |
| Type | Integration |
| Component Under Test | GET /api/projects/:projectId |
| Preconditions | User A in Org A, Project in Org B |
| Test Input | User A token, Project B ID |
| Expected Result | Access denied |
| Verification Points | Response status is 404 (not 403, to prevent enumeration) |

#### TR-MT-002: Disabled Organization Access

| Field | Value |
|-------|-------|
| Traces to | US-PLAT-003, AC: disabled org users see contact support message |
| Type | Integration |
| Component Under Test | Any authenticated endpoint |
| Preconditions | User's organization is disabled |
| Test Input | Valid user token from disabled org |
| Expected Result | Access denied |
| Verification Points | Response status is 403; Error code is ORGANIZATION_DISABLED |

### 2.10 Health Check Tests

#### TR-HEALTH-001: Health Endpoint Success

| Field | Value |
|-------|-------|
| Traces to | Replit deployment requirement |
| Type | Integration |
| Component Under Test | GET /api/health |
| Preconditions | Application running, database connected |
| Test Input | None |
| Expected Result | Health status returned |
| Verification Points | Response status is 200; Response contains status: "healthy"; Response contains database connectivity check |

#### TR-HEALTH-002: Health Endpoint Database Failure

| Field | Value |
|-------|-------|
| Traces to | Health check specification |
| Type | Integration |
| Component Under Test | GET /api/health |
| Preconditions | Database unavailable |
| Test Input | None |
| Expected Result | Unhealthy status returned |
| Verification Points | Response status is 503; Status is unhealthy; Database check shows error |

---

## 3. API Endpoint Test Matrix

### 3.1 Authentication Endpoints

| Endpoint | Method | Success Test | Error Tests | Auth Test |
|----------|--------|--------------|-------------|-----------|
| /api/auth/login | POST | TR-AUTH-001 | TR-AUTH-002, TR-AUTH-003 | N/A |
| /api/auth/logout | POST | Logout clears session | 401 no token | Required |
| /api/auth/refresh | POST | New tokens issued | 401 invalid refresh | Cookie |
| /api/auth/me | GET | Returns current user | TR-AUTH-004 | Required |
| /api/auth/forgot-password | POST | TR-AUTH-005 | 404 user not found | N/A |
| /api/auth/reset-password | POST | TR-AUTH-005 | TR-AUTH-006 | N/A |

### 3.2 Invitation Endpoints

| Endpoint | Method | Success Test | Error Tests | Auth Test |
|----------|--------|--------------|-------------|-----------|
| /api/invitations | POST | TR-INV-001 | 403 not admin, 409 duplicate | Admin |
| /api/invitations | GET | List pending | 403 not admin | Admin |
| /api/invitations/:id | DELETE | Cancel invitation | 404 not found | Admin |
| /api/invitations/:token/validate | GET | Token valid | TR-INV-003 | Public |
| /api/invitations/:token/accept | POST | TR-INV-002 | TR-INV-003, 409 already accepted | Public |

### 3.3 Resource Endpoints

| Endpoint | Method | Success Test | Error Tests | Auth Test |
|----------|--------|--------------|-------------|-----------|
| /api/projects | POST | TR-PROJ-001 | TR-PROJ-002, 403 viewer | Editor |
| /api/projects | GET | List projects | 401 no token | Viewer |
| /api/projects/:id | GET | Get project | 400 invalid ID, 404 not found | Viewer |
| /api/projects/:id | PATCH | Update project | 403 viewer, 404 not found | Editor |
| /api/projects/:id/archive | POST | TR-PROJ-003 | 404 not found | Editor |
| /api/projects/:id/sources/file | POST | TR-FILE-001 | TR-FILE-002, TR-FILE-003 | Editor |
| /api/sources/:id | GET | Get source | 404 not found | Viewer |
| /api/sources/:id/test | POST | TR-API-001 | TR-API-002 | Editor |
| /api/projects/:id/jobs | POST | TR-PROC-001 | 422 no sources | Editor |
| /api/jobs/:id | GET | Get job status | 404 not found | Viewer |
| /api/jobs/:id/cancel | POST | TR-PROC-002 | TR-PROC-003 | Editor |
| /api/jobs/:id/exports | POST | TR-EXP-001 | 422 job not completed | Editor |
| /api/exports/:id/download | GET | TR-EXP-002 | TR-EXP-003 | Viewer |

### 3.4 Input Validation Matrix

All parameterized endpoints must reject invalid IDs:

| Invalid Input | Expected Status | Expected Code |
|---------------|-----------------|---------------|
| `abc` (non-numeric) | 400 | INVALID_ID |
| `-1` (negative) | 400 | INVALID_ID |
| `0` (zero) | 400 | INVALID_ID |
| `1.5` (decimal) | 400 | INVALID_ID |

---

## 4. UI Test Requirements

### 4.1 Screen State Coverage

| Screen | Loading | Default | Empty | Error |
|--------|---------|---------|-------|-------|
| Login | N/A | Form displayed | N/A | Invalid credentials shown |
| Accept Invitation | Validating token | Form for name/password | N/A | Expired/invalid token message |
| Dashboard | Skeleton cards | Projects summary | "No projects" CTA | API error toast |
| Project List | Skeleton rows | Project cards with status | "Create first project" CTA | API error toast |
| Sources Tab | Skeleton | Source cards | "Add first source" CTA | Connection error shown |
| Mapping Tab | Skeleton | Mapping table | "No fields detected" | Mapping error shown |
| Processing Tab | Skeleton | Job history | "Run first processing" CTA | Job error details |
| Exports Tab | Skeleton | Export list | "Generate first export" | Export error shown |
| Team | Skeleton | Member list | "Invite first member" (admin) | API error toast |
| Audit Log | Skeleton | Log entries table | "No activity yet" | API error toast |

### 4.2 Form Validation Requirements

#### Login Form

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error |
|-------|-----------------|-------------|---------------|----------------|
| email | Required, email format | "user@example.com" | "not-an-email" | "Invalid email format" |
| password | Required | "Password123!" | "" | "Password is required" |

#### Create Project Form

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error |
|-------|-----------------|-------------|---------------|----------------|
| name | Required, 1-100 chars | "My Project" | "" | "Name is required" |
| name | Max 100 chars | 100-char string | 101-char string | "Name too long" |
| description | Optional, max 500 chars | "Description" | 501-char string | "Description too long" |

#### Accept Invitation Form

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error |
|-------|-----------------|-------------|---------------|----------------|
| name | Required, 1-255 chars | "John Doe" | "" | "Name is required" |
| password | Required, min 8, uppercase, number | "ValidPass1" | "short" | "Min 8 characters" |
| confirmPassword | Must match password | Matching | Non-matching | "Passwords don't match" |

#### Teamwork Desk Connection Form

| Field | Validation Rule | Valid Input | Invalid Input | Expected Error |
|-------|-----------------|-------------|---------------|----------------|
| subdomain | Required | "mycompany" | "" | "Subdomain required" |
| apiKey | Required | "valid-api-key" | "" | "API key required" |

### 4.3 Interactive Element Requirements

| Element | Location | Expected Action | Success Indicator |
|---------|----------|-----------------|-------------------|
| Login button | Login form | POST /api/auth/login | Redirect to dashboard |
| Create Project | Dashboard/Projects | Opens create dialog | Dialog visible |
| Save Project | Create dialog | POST /api/projects | Toast + redirect to project |
| Upload File | Sources tab | File picker + upload | Progress bar → source card |
| Test Connection | Source config | POST /api/sources/:id/test | Success/failure indicator |
| Run Processing | Processing tab | POST /api/projects/:id/jobs | Progress component shown |
| Cancel Job | Processing tab | POST /api/jobs/:id/cancel | Status → cancelled |
| Download Export | Exports tab | GET /api/exports/:id/download | File download starts |
| Invite Member | Team page | POST /api/invitations | Toast + member in pending list |
| Remove Member | Team page | DELETE /api/team/:id | Member removed from list |

---

## 5. Test Coverage Matrix

### 5.1 User Story Traceability

| User Story | Acceptance Criteria Count | Test Requirements | Coverage |
|------------|--------------------------|-------------------|----------|
| US-AUTH-001 | 3 | TR-INV-001, TR-INV-002, TR-INV-003 | 100% |
| US-AUTH-002 | 3 | TR-AUTH-001, TR-AUTH-002, TR-AUTH-004 | 100% |
| US-AUTH-003 | 3 | TR-ROLE-001, TR-ROLE-002, TR-ROLE-003 | 100% |
| US-AUTH-004 | 3 | TR-ROLE-004 | 100% |
| US-AUTH-005 | 3 | TR-AUTH-005, TR-AUTH-006 | 100% |
| US-ORG-002 | 3 | TR-PROJ-001, TR-PROJ-002 | 100% |
| US-ORG-003 | 3 | TR-PROJ-003 | 100% |
| US-FILE-001 | 4 | TR-FILE-001, TR-FILE-002 | 100% |
| US-FILE-002 | 3 | TR-FILE-004 | 100% |
| US-FILE-003 | 3 | TR-FILE-005 | 100% |
| US-API-TD-001 | 3 | TR-API-001, TR-API-002 | 100% |
| US-API-GHL-001 | 3 | TR-API-003 | 100% |
| US-PROC-001 | 3 | TR-PROC-001 | 100% |
| US-PROC-003 | 3 | TR-PROC-002, TR-PROC-003 | 100% |
| US-EXP-001 | 3 | TR-EXP-001, TR-EXP-002 | 100% |
| US-EXP-004 | 3 | TR-EXP-003 | 100% |
| US-PLAT-003 | 3 | TR-MT-002 | 100% |

### 5.2 Critical Path Coverage

| Critical Path | Steps | Test Requirements |
|---------------|-------|-------------------|
| First-run flow | Login → Dashboard → Create Project → Add Source → Configure Mapping → Run Processing → Export → Download | TR-AUTH-001, TR-PROJ-001, TR-FILE-001, TR-PROC-001, TR-EXP-001, TR-EXP-002 |
| Team invite flow | Admin → Team → Invite → Accept → Dashboard | TR-INV-001, TR-INV-002 |
| API connection flow | Project → Add Source → Teamwork → Test → Connect | TR-API-001 |

---

## 6. Deployment Specification

### 6.1 Environment Variables

| Variable | Classification | Format | Description | Default |
|----------|---------------|--------|-------------|---------|
| DATABASE_URL | REQUIRED | `postgresql://...` | Neon PostgreSQL connection string | None |
| JWT_SECRET | REQUIRED | 32+ char string | Token signing secret | None |
| SESSION_SECRET | REQUIRED | 32+ char string | Session encryption | None |
| APP_URL | REQUIRED | `https://...` | Application base URL | None |
| PORT | REQUIRED_WITH_DEFAULT | Integer | Server port | 3001 (dev), 5000 (prod) |
| NODE_ENV | REQUIRED_WITH_DEFAULT | String | Environment mode | development |
| RESEND_API_KEY | OPTIONAL | `re_...` | Email service API key | None (emails logged) |
| ENCRYPTION_KEY | OPTIONAL | 32+ char string | API credential encryption | None (plaintext in dev) |

**Classification Legend:**
- **REQUIRED**: Server fails to start if missing
- **REQUIRED_WITH_DEFAULT**: Has fallback value, override recommended
- **OPTIONAL**: Feature disabled if missing (graceful degradation)

### 6.2 Pre-Deployment Checklist

- [ ] All REQUIRED environment variables set in Replit Secrets
- [ ] DATABASE_URL points to production Neon database
- [ ] JWT_SECRET is unique, cryptographically random, 32+ characters
- [ ] SESSION_SECRET is unique, cryptographically random, 32+ characters
- [ ] APP_URL matches Replit deployment URL
- [ ] OPTIONAL services configured or intentionally disabled

### 6.3 Deployment Steps

1. [ ] Install dependencies: `npm install`
2. [ ] Run database migrations: `npm run db:push` (uses tsx wrapper: `tsx node_modules/drizzle-kit/bin.cjs push`)
3. [ ] Build application: `npm run build`
4. [ ] Start application: `npm run start`
5. [ ] Verify server listening on port 5000

### 6.4 Replit Configuration Verification

| Requirement | Location | Expected Value |
|-------------|----------|----------------|
| Server port | .replit, vite.config.ts | 5000 |
| Vite host binding | vite.config.ts | `host: '0.0.0.0'` |
| Vite allowed hosts | vite.config.ts | `allowedHosts: true` |
| Drizzle migration command | package.json | Uses tsx wrapper |
| Static file serving | server/index.ts | `dist/public` in production |
| External port mapping | .replit | `localPort: 5000, externalPort: 80` |

---

## 7. Health Check Specification

### 7.1 Endpoint: GET /api/health

**Success Response (200):**

| Field | Type | Description |
|-------|------|-------------|
| status | "healthy" | Overall application status |
| timestamp | ISO 8601 | Current server time |
| version | string | Application version |
| uptime | number | Seconds since server start |
| checks.database.status | "connected" | Database connectivity |
| checks.database.latency_ms | number | Query latency in milliseconds |
| features.email | boolean | Resend API configured |
| features.encryption | boolean | Encryption key configured |

**Failure Response (503):**

| Field | Type | Description |
|-------|------|-------------|
| status | "unhealthy" | Overall status |
| timestamp | ISO 8601 | Current server time |
| checks.database.status | "disconnected" | Database failed |
| checks.database.error | string | Error message |

### 7.2 Health Check Verification

- [ ] GET /api/health returns 200 when database connected
- [ ] Response includes all documented fields
- [ ] Database latency reported accurately
- [ ] Feature flags reflect actual configuration
- [ ] Returns 503 when database unavailable

---

## 8. Post-Deployment Validation

### 8.1 Smoke Test Checklist

- [ ] Home page loads without JavaScript console errors
- [ ] Login page renders correctly
- [ ] Health endpoint returns 200 with healthy status
- [ ] Can create new user via invitation flow (or seed data exists)
- [ ] Login succeeds with valid credentials
- [ ] Dashboard loads after login
- [ ] Protected routes redirect unauthenticated users to login
- [ ] Can create a new project
- [ ] Can upload a file source
- [ ] Can view source preview data
- [ ] Logout works and clears session

### 8.2 Functional Verification

- [ ] Authentication flow works (login, logout, token refresh)
- [ ] Role-based access enforced (viewer, editor, admin boundaries)
- [ ] File upload accepts CSV, Excel, JSON under 50MB
- [ ] File upload rejects files over 50MB
- [ ] Processing job starts and updates progress
- [ ] Export generation completes for completed jobs
- [ ] Export download works
- [ ] Multi-tenant isolation verified (cannot access other org data)
- [ ] Rate limiting activates after threshold

### 8.3 Technical Verification

- [ ] No JavaScript console errors in browser
- [ ] API responses match documented schemas
- [ ] Response times under 2 seconds for typical operations
- [ ] Database connections not exhausted under load
- [ ] Static assets served correctly (CSS, JS, images)

### 8.4 Rollback Criteria

Rollback immediately if any of the following occur:

- [ ] Health endpoint returns 503
- [ ] Login flow fails for all users
- [ ] Database connection errors in logs
- [ ] 500 errors on primary operations (projects, sources, jobs)
- [ ] Authentication bypass detected
- [ ] Data visible across organization boundaries

---

## 9. Test Data Requirements

### 9.1 Seed Data Specification

| Entity | Test Data | Purpose |
|--------|-----------|---------|
| Organization | "Test Org" (active), "Disabled Org" (disabled) | Multi-tenant testing |
| Users | Admin, Editor, Viewer in each org | Role testing |
| Platform Admin | One platform admin user | Admin feature testing |
| Projects | Active project, archived project | Lifecycle testing |
| Sources | File source, API source (mock) | Source type testing |
| Jobs | Pending, running, completed, failed, cancelled | Status testing |
| Exports | Active export, expired export | Expiry testing |
| Invitations | Valid invitation, expired invitation | Flow testing |

### 9.2 Test File Requirements

| File Type | Size | Characteristics | Purpose |
|-----------|------|-----------------|---------|
| CSV | < 1MB | 100 rows, 10 columns | Basic upload testing |
| CSV | 49MB | 100K rows | Near-limit testing |
| CSV | 51MB | Over limit | Rejection testing |
| Excel | < 1MB | 3 sheets | Multi-sheet testing |
| JSON | < 1MB | Nested structure | Path selection testing |
| JSON | Invalid | Syntax error at line 5 | Error reporting testing |

---

## 10. Validation Checklist

### Content Verification

- [x] Zero test implementation code in document
- [x] All test requirements use specification format
- [x] All deployment steps are checklists
- [x] Traceability complete (every major spec item has test requirement)

### Replit Verification

- [x] Port 5000 documented
- [x] Health endpoint specified
- [x] Environment variables classified
- [x] Drizzle tsx wrapper noted
- [x] Vite binding documented

### Format Verification

- [x] Document under 600 lines
- [x] Tables used for structured data
- [x] Checkboxes used for checklists
- [x] Clear section hierarchy

---

**Document Status: COMPLETE**

---

*Document End*
